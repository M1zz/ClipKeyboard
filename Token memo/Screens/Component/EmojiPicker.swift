//
//  EmojiPicker.swift
//  Token memo
//
//  Created by Claude Code
//

import SwiftUI

// MARK: - Emoji Category
enum EmojiCategory: String, CaseIterable {
    case recent = "ìµœê·¼ ì‚¬ìš©"
    case smileys = "í‘œì •"
    case gestures = "ì†ì§“"
    case people = "ì‚¬ëžŒ"
    case animals = "ë™ë¬¼"
    case food = "ìŒì‹"
    case travel = "ì—¬í–‰"
    case activities = "í™œë™"
    case objects = "ë¬¼ê±´"
    case symbols = "ê¸°í˜¸"
    case flags = "êµ­ê¸°"

    var icon: String {
        switch self {
        case .recent: return "clock.fill"
        case .smileys: return "face.smiling"
        case .gestures: return "hand.raised.fill"
        case .people: return "person.fill"
        case .animals: return "pawprint.fill"
        case .food: return "fork.knife"
        case .travel: return "airplane"
        case .activities: return "sportscourt.fill"
        case .objects: return "lightbulb.fill"
        case .symbols: return "heart.fill"
        case .flags: return "flag.fill"
        }
    }

    var emojis: [String] {
        switch self {
        case .recent:
            return EmojiPickerService.shared.getRecentEmojis()
        case .smileys:
            return ["ðŸ˜€", "ðŸ˜ƒ", "ðŸ˜„", "ðŸ˜", "ðŸ˜†", "ðŸ˜…", "ðŸ¤£", "ðŸ˜‚", "ðŸ™‚", "ðŸ™ƒ", "ðŸ˜‰", "ðŸ˜Š", "ðŸ˜‡", "ðŸ¥°", "ðŸ˜", "ðŸ¤©", "ðŸ˜˜", "ðŸ˜—", "ðŸ˜š", "ðŸ˜™", "ðŸ¥²", "ðŸ˜‹", "ðŸ˜›", "ðŸ˜œ", "ðŸ¤ª", "ðŸ˜", "ðŸ¤‘", "ðŸ¤—", "ðŸ¤­", "ðŸ¤«", "ðŸ¤”", "ðŸ¤", "ðŸ¤¨", "ðŸ˜", "ðŸ˜‘", "ðŸ˜¶", "ðŸ˜", "ðŸ˜’", "ðŸ™„", "ðŸ˜¬", "ðŸ¤¥", "ðŸ˜Œ", "ðŸ˜”", "ðŸ˜ª", "ðŸ¤¤", "ðŸ˜´", "ðŸ˜·", "ðŸ¤’", "ðŸ¤•", "ðŸ¤¢", "ðŸ¤®", "ðŸ¤§", "ðŸ¥µ", "ðŸ¥¶", "ðŸ¥´", "ðŸ˜µ", "ðŸ¤¯", "ðŸ¤ ", "ðŸ¥³", "ðŸ¥¸", "ðŸ˜Ž", "ðŸ¤“", "ðŸ§"]
        case .gestures:
            return ["ðŸ‘‹", "ðŸ¤š", "ðŸ–", "âœ‹", "ðŸ––", "ðŸ‘Œ", "ðŸ¤Œ", "ðŸ¤", "âœŒï¸", "ðŸ¤ž", "ðŸ¤Ÿ", "ðŸ¤˜", "ðŸ¤™", "ðŸ‘ˆ", "ðŸ‘‰", "ðŸ‘†", "ðŸ–•", "ðŸ‘‡", "â˜ï¸", "ðŸ‘", "ðŸ‘Ž", "âœŠ", "ðŸ‘Š", "ðŸ¤›", "ðŸ¤œ", "ðŸ‘", "ðŸ™Œ", "ðŸ‘", "ðŸ¤²", "ðŸ¤", "ðŸ™", "âœï¸", "ðŸ’…", "ðŸ¤³", "ðŸ’ª", "ðŸ¦µ", "ðŸ¦¶"]
        case .people:
            return ["ðŸ‘¶", "ðŸ‘§", "ðŸ§’", "ðŸ‘¦", "ðŸ‘©", "ðŸ§‘", "ðŸ‘¨", "ðŸ‘©â€ðŸ¦±", "ðŸ§‘â€ðŸ¦±", "ðŸ‘¨â€ðŸ¦±", "ðŸ‘©â€ðŸ¦°", "ðŸ§‘â€ðŸ¦°", "ðŸ‘¨â€ðŸ¦°", "ðŸ‘±â€â™€ï¸", "ðŸ‘±", "ðŸ‘±â€â™‚ï¸", "ðŸ‘©â€ðŸ¦³", "ðŸ§‘â€ðŸ¦³", "ðŸ‘¨â€ðŸ¦³", "ðŸ‘©â€ðŸ¦²", "ðŸ§‘â€ðŸ¦²", "ðŸ‘¨â€ðŸ¦²", "ðŸ§”", "ðŸ‘µ", "ðŸ§“", "ðŸ‘´", "ðŸ‘²", "ðŸ‘³â€â™€ï¸", "ðŸ‘³", "ðŸ‘³â€â™‚ï¸", "ðŸ§•", "ðŸ‘®â€â™€ï¸", "ðŸ‘®", "ðŸ‘®â€â™‚ï¸", "ðŸ‘·â€â™€ï¸", "ðŸ‘·", "ðŸ‘·â€â™‚ï¸", "ðŸ’‚â€â™€ï¸", "ðŸ’‚", "ðŸ’‚â€â™‚ï¸"]
        case .animals:
            return ["ðŸ¶", "ðŸ±", "ðŸ­", "ðŸ¹", "ðŸ°", "ðŸ¦Š", "ðŸ»", "ðŸ¼", "ðŸ¨", "ðŸ¯", "ðŸ¦", "ðŸ®", "ðŸ·", "ðŸ½", "ðŸ¸", "ðŸµ", "ðŸ™ˆ", "ðŸ™‰", "ðŸ™Š", "ðŸ’", "ðŸ”", "ðŸ§", "ðŸ¦", "ðŸ¤", "ðŸ£", "ðŸ¥", "ðŸ¦†", "ðŸ¦…", "ðŸ¦‰", "ðŸ¦‡", "ðŸº", "ðŸ—", "ðŸ´", "ðŸ¦„", "ðŸ", "ðŸ›", "ðŸ¦‹", "ðŸŒ", "ðŸž", "ðŸœ", "ðŸ¦Ÿ", "ðŸ¦—", "ðŸ•·", "ðŸ¦‚", "ðŸ¢", "ðŸ", "ðŸ¦Ž", "ðŸ¦–", "ðŸ¦•", "ðŸ™", "ðŸ¦‘", "ðŸ¦", "ðŸ¦ž", "ðŸ¦€", "ðŸ¡", "ðŸ ", "ðŸŸ", "ðŸ¬", "ðŸ³", "ðŸ‹", "ðŸ¦ˆ"]
        case .food:
            return ["ðŸŽ", "ðŸ", "ðŸŠ", "ðŸ‹", "ðŸŒ", "ðŸ‰", "ðŸ‡", "ðŸ“", "ðŸˆ", "ðŸ’", "ðŸ‘", "ðŸ¥­", "ðŸ", "ðŸ¥¥", "ðŸ¥", "ðŸ…", "ðŸ†", "ðŸ¥‘", "ðŸ¥¦", "ðŸ¥¬", "ðŸ¥’", "ðŸŒ¶", "ðŸŒ½", "ðŸ¥•", "ðŸ§„", "ðŸ§…", "ðŸ¥”", "ðŸ ", "ðŸ¥", "ðŸ¥¯", "ðŸž", "ðŸ¥–", "ðŸ¥¨", "ðŸ§€", "ðŸ¥š", "ðŸ³", "ðŸ§ˆ", "ðŸ¥ž", "ðŸ§‡", "ðŸ¥“", "ðŸ¥©", "ðŸ—", "ðŸ–", "ðŸŒ­", "ðŸ”", "ðŸŸ", "ðŸ•", "ðŸ¥ª", "ðŸ¥™", "ðŸ§†", "ðŸŒ®", "ðŸŒ¯", "ðŸ¥—", "ðŸ¥˜", "ðŸ", "ðŸœ", "ðŸ²", "ðŸ›", "ðŸ£", "ðŸ±", "ðŸ¥Ÿ", "ðŸ¦ª", "ðŸ¤", "ðŸ™", "ðŸš", "ðŸ˜", "ðŸ¥"]
        case .travel:
            return ["ðŸš—", "ðŸš•", "ðŸš™", "ðŸšŒ", "ðŸšŽ", "ðŸŽ", "ðŸš“", "ðŸš‘", "ðŸš’", "ðŸš", "ðŸ›»", "ðŸšš", "ðŸš›", "ðŸšœ", "ðŸ¦¯", "ðŸ¦½", "ðŸ¦¼", "ðŸ›´", "ðŸš²", "ðŸ›µ", "ðŸ", "ðŸ›º", "ðŸš¨", "ðŸš”", "ðŸš", "ðŸš˜", "ðŸš–", "ðŸš¡", "ðŸš ", "ðŸšŸ", "ðŸšƒ", "ðŸš‹", "ðŸšž", "ðŸš", "ðŸš„", "ðŸš…", "ðŸšˆ", "ðŸš‚", "ðŸš†", "ðŸš‡", "ðŸšŠ", "ðŸš‰", "âœˆï¸", "ðŸ›«", "ðŸ›¬", "ðŸ›©", "ðŸ’º", "ðŸ›°", "ðŸš", "ðŸ›¸", "ðŸš€", "ðŸ›¶", "â›µï¸", "ðŸš¤", "ðŸ›¥", "ðŸ›³", "â›´", "ðŸš¢"]
        case .activities:
            return ["âš½ï¸", "ðŸ€", "ðŸˆ", "âš¾ï¸", "ðŸ¥Ž", "ðŸŽ¾", "ðŸ", "ðŸ‰", "ðŸ¥", "ðŸŽ±", "ðŸª€", "ðŸ“", "ðŸ¸", "ðŸ’", "ðŸ‘", "ðŸ¥", "ðŸ", "ðŸªƒ", "ðŸ¥…", "â›³ï¸", "ðŸª", "ðŸ¹", "ðŸŽ£", "ðŸ¤¿", "ðŸ¥Š", "ðŸ¥‹", "ðŸŽ½", "ðŸ›¹", "ðŸ›¼", "ðŸ›·", "â›¸", "ðŸ¥Œ", "ðŸŽ¿", "â›·", "ðŸ‚", "ðŸª‚", "ðŸ‹ï¸â€â™€ï¸", "ðŸ‹ï¸", "ðŸ‹ï¸â€â™‚ï¸", "ðŸ¤¼â€â™€ï¸", "ðŸ¤¼", "ðŸ¤¼â€â™‚ï¸", "ðŸ¤¸â€â™€ï¸", "ðŸ¤¸", "ðŸ¤¸â€â™‚ï¸", "â›¹ï¸â€â™€ï¸", "â›¹ï¸", "â›¹ï¸â€â™‚ï¸", "ðŸ¤º", "ðŸ¤¾â€â™€ï¸", "ðŸ¤¾", "ðŸ¤¾â€â™‚ï¸", "ðŸŒï¸â€â™€ï¸", "ðŸŒï¸", "ðŸŒï¸â€â™‚ï¸"]
        case .objects:
            return ["âŒšï¸", "ðŸ“±", "ðŸ“²", "ðŸ’»", "âŒ¨ï¸", "ðŸ–¥", "ðŸ–¨", "ðŸ–±", "ðŸ–²", "ðŸ•¹", "ðŸ—œ", "ðŸ’½", "ðŸ’¾", "ðŸ’¿", "ðŸ“€", "ðŸ“¼", "ðŸ“·", "ðŸ“¸", "ðŸ“¹", "ðŸŽ¥", "ðŸ“½", "ðŸŽž", "ðŸ“ž", "â˜Žï¸", "ðŸ“Ÿ", "ðŸ“ ", "ðŸ“º", "ðŸ“»", "ðŸŽ™", "ðŸŽš", "ðŸŽ›", "ðŸ§­", "â±", "â²", "â°", "ðŸ•°", "âŒ›ï¸", "â³", "ðŸ“¡", "ðŸ”‹", "ðŸ”Œ", "ðŸ’¡", "ðŸ”¦", "ðŸ•¯", "ðŸª”", "ðŸ§¯", "ðŸ›¢", "ðŸ’¸", "ðŸ’µ", "ðŸ’´", "ðŸ’¶", "ðŸ’·", "ðŸª™", "ðŸ’°", "ðŸ’³", "ðŸ’Ž", "âš–ï¸", "ðŸªœ", "ðŸ§°", "ðŸª›", "ðŸ”§", "ðŸ”¨", "âš’", "ðŸ› ", "â›", "ðŸª“"]
        case .symbols:
            return ["â¤ï¸", "ðŸ§¡", "ðŸ’›", "ðŸ’š", "ðŸ’™", "ðŸ’œ", "ðŸ–¤", "ðŸ¤", "ðŸ¤Ž", "ðŸ’”", "â£ï¸", "ðŸ’•", "ðŸ’ž", "ðŸ’“", "ðŸ’—", "ðŸ’–", "ðŸ’˜", "ðŸ’", "ðŸ’Ÿ", "â˜®ï¸", "âœï¸", "â˜ªï¸", "ðŸ•‰", "â˜¸ï¸", "âœ¡ï¸", "ðŸ”¯", "ðŸ•Ž", "â˜¯ï¸", "â˜¦ï¸", "ðŸ›", "â›Ž", "â™ˆï¸", "â™‰ï¸", "â™Šï¸", "â™‹ï¸", "â™Œï¸", "â™ï¸", "â™Žï¸", "â™ï¸", "â™ï¸", "â™‘ï¸", "â™’ï¸", "â™“ï¸", "ðŸ†”", "âš›ï¸", "ðŸ‰‘", "â˜¢ï¸", "â˜£ï¸", "ðŸ“´", "ðŸ“³", "ðŸˆ¶", "ðŸˆšï¸", "ðŸˆ¸", "ðŸˆº", "ðŸˆ·ï¸", "âœ´ï¸", "ðŸ†š", "ðŸ’®", "ðŸ‰", "ãŠ™ï¸", "ãŠ—ï¸", "ðŸˆ´", "ðŸˆµ"]
        case .flags:
            return ["ðŸ", "ðŸš©", "ðŸŽŒ", "ðŸ´", "ðŸ³ï¸", "ðŸ³ï¸â€ðŸŒˆ", "ðŸ³ï¸â€âš§ï¸", "ðŸ´â€â˜ ï¸", "ðŸ‡°ðŸ‡·", "ðŸ‡ºðŸ‡¸", "ðŸ‡¯ðŸ‡µ", "ðŸ‡¨ðŸ‡³", "ðŸ‡¬ðŸ‡§", "ðŸ‡«ðŸ‡·", "ðŸ‡©ðŸ‡ª", "ðŸ‡®ðŸ‡¹", "ðŸ‡ªðŸ‡¸", "ðŸ‡¨ðŸ‡¦", "ðŸ‡¦ðŸ‡º", "ðŸ‡§ðŸ‡·", "ðŸ‡®ðŸ‡³", "ðŸ‡·ðŸ‡º", "ðŸ‡²ðŸ‡½", "ðŸ‡¹ðŸ‡­", "ðŸ‡»ðŸ‡³", "ðŸ‡¸ðŸ‡¬", "ðŸ‡µðŸ‡­", "ðŸ‡®ðŸ‡©", "ðŸ‡²ðŸ‡¾"]
        }
    }
}

// MARK: - Emoji Picker Service
class EmojiPickerService {
    static let shared = EmojiPickerService()
    private let recentEmojisKey = "recentEmojis"
    private let maxRecentEmojis = 30

    private init() {}

    func getRecentEmojis() -> [String] {
        return UserDefaults.standard.stringArray(forKey: recentEmojisKey) ?? []
    }

    func addRecentEmoji(_ emoji: String) {
        var recents = getRecentEmojis()

        // ì¤‘ë³µ ì œê±°
        recents.removeAll { $0 == emoji }

        // ë§¨ ì•žì— ì¶”ê°€
        recents.insert(emoji, at: 0)

        // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
        if recents.count > maxRecentEmojis {
            recents = Array(recents.prefix(maxRecentEmojis))
        }

        UserDefaults.standard.set(recents, forKey: recentEmojisKey)
    }
}

// MARK: - Emoji Picker View
struct EmojiPicker: View {
    @Environment(\.dismiss) private var dismiss
    @State private var selectedCategory: EmojiCategory = .smileys
    @State private var searchText: String = ""

    let onEmojiSelected: (String) -> Void

    private let columns = Array(repeating: GridItem(.flexible(), spacing: 8), count: 7)

    var body: some View {
        NavigationView {
            VStack(spacing: 0) {
                // ì¹´í…Œê³ ë¦¬ íƒ­
                ScrollView(.horizontal, showsIndicators: false) {
                    HStack(spacing: 12) {
                        ForEach(EmojiCategory.allCases, id: \.self) { category in
                            // ìµœê·¼ ì‚¬ìš©ì´ ë¹„ì–´ìžˆìœ¼ë©´ ìŠ¤í‚µ
                            if category == .recent && category.emojis.isEmpty {
                                EmptyView()
                            } else {
                                CategoryTab(
                                    category: category,
                                    isSelected: selectedCategory == category
                                ) {
                                    withAnimation(.easeInOut(duration: 0.2)) {
                                        selectedCategory = category
                                    }
                                }
                            }
                        }
                    }
                    .padding(.horizontal)
                    .padding(.vertical, 12)
                }
                .background(Color(.systemBackground))

                Divider()

                // ì´ëª¨ì§€ ê·¸ë¦¬ë“œ
                ScrollView {
                    LazyVGrid(columns: columns, spacing: 12) {
                        ForEach(filteredEmojis, id: \.self) { emoji in
                            Button {
                                selectEmoji(emoji)
                            } label: {
                                Text(emoji)
                                    .font(.system(size: 32))
                            }
                            .buttonStyle(EmojiButtonStyle())
                        }
                    }
                    .padding()
                }
            }
            .navigationTitle("ì´ëª¨ì§€ ì„ íƒ")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("ì™„ë£Œ") {
                        dismiss()
                    }
                }
            }
        }
    }

    private var filteredEmojis: [String] {
        let emojis = selectedCategory.emojis

        if searchText.isEmpty {
            return emojis
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥ (í–¥í›„ í™•ìž¥ ê°€ëŠ¥)
        return emojis
    }

    private func selectEmoji(_ emoji: String) {
        // ìµœê·¼ ì‚¬ìš©ì— ì¶”ê°€
        EmojiPickerService.shared.addRecentEmoji(emoji)

        // ì½œë°± ì‹¤í–‰
        onEmojiSelected(emoji)

        // í”¼ì»¤ ë‹«ê¸°
        dismiss()
    }
}

// MARK: - Category Tab
struct CategoryTab: View {
    let category: EmojiCategory
    let isSelected: Bool
    let action: () -> Void

    var body: some View {
        Button(action: action) {
            VStack(spacing: 4) {
                Image(systemName: category.icon)
                    .font(.system(size: 20))

                Text(category.rawValue)
                    .font(.caption2)
            }
            .foregroundColor(isSelected ? .blue : .secondary)
            .frame(width: 60)
            .padding(.vertical, 8)
            .background(
                RoundedRectangle(cornerRadius: 8)
                    .fill(isSelected ? Color.blue.opacity(0.1) : Color.clear)
            )
        }
        .buttonStyle(.plain)
    }
}

// MARK: - Emoji Button Style
struct EmojiButtonStyle: ButtonStyle {
    func makeBody(configuration: Configuration) -> some View {
        configuration.label
            .scaleEffect(configuration.isPressed ? 1.2 : 1.0)
            .animation(.spring(response: 0.3, dampingFraction: 0.6), value: configuration.isPressed)
    }
}

// MARK: - Preview
struct EmojiPicker_Previews: PreviewProvider {
    static var previews: some View {
        EmojiPicker { emoji in
            print("Selected: \(emoji)")
        }
    }
}
